<% environment.context_class.instance_eval { include ApplicationHelper } %>
// this code instantiates the ace window.mainEditor
$( document ).on( 'page:change', function(){

  var 
    $textarea          = $( 'textarea#gist_content' ),
    $editorContentArea = $('.ace_content');
    editor             = ace.edit("editor");

  editor.setValue( $textarea.val(), 1 );

  editor.setTheme("ace/theme/eclipse");
  editor.getSession().setMode("ace/mode/text");

  editor.getSession().on('change', function() {
    $textarea.val( editor.getSession().getValue() );

    window.mainCanvas.changeCanvasSize( { width: $editorContentArea.width() });
  });


  editor.getSession().on('changeScrollTop', function( scroll ){
    window.mainCanvas.scrollCanvasY( scroll );
  });

  $('div.ace_scrollbar.ace_scrollbar-h').on('scroll', function(){
    window.mainCanvas.scrollCanvasX( $(this).scrollLeft() );
  });


  var gistLanguage       = $('#gist_language'),
      supportedLanguages = JSON.parse('<%= supported_languages.to_json %>');

  var toAceLang = function( lang ){
    switch( lang ){
      case 'C/C++':
        return 'c_cpp';
        break;        
      default:
        return lang.toLowerCase();
    }
  };

  gistLanguage.on('change', function(){
    var 
      $this    = $(this),
      language = $this.val();
    
    if( supportedLanguages.indexOf( language ) >= 0 ){
      editor.session.getUndoManager().markClean();
      editor.getSession().setMode('ace/mode/' + toAceLang( language ) );
    }
  });

});
